<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Taskä¸€è¦§</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav>
    <a href="index.html">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
    <a href="project-list.html">ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</a>
    <a href="task-list.html">âœ… ã‚¿ã‚¹ã‚¯ä¸€è¦§</a>
    <a href="mislenge-create.html">â• Mission / Project ä½œæˆ</a>
  </nav>

  <div class="container">
    <h1>ğŸ“Œ ã‚¿ã‚¹ã‚¯ä¸€è¦§</h1>
      <div id="taskContainer"></div>
  </div>

  <div id="taskEditPopup" class="popup">
    <h2>ã‚¿ã‚¹ã‚¯ç·¨é›†</h2>

    <label for="editTaskName">ã‚¿ã‚¹ã‚¯å</label>
    <input type="text" id="editTaskName">

    <div id="taskEditFields">
        <label for="editTaskDeadline">ç· ã‚åˆ‡ã‚Šæ—¥</label>
        <input type="date" id="editTaskDeadline">

        <label for="editScheduledDate">äºˆå®šæ—¥</label>
        <input type="date" id="editScheduledDate">

        <label for="editPriority">å„ªå…ˆåº¦</label>
        <select id="editPriority">
            <option value="çµ¶å¯¾">çµ¶å¯¾</option>
            <option value="ã§ããŸã‚‰">ã§ããŸã‚‰</option>
            <option value="ã‚„ã£ãŸã‚‰ãŠã‚‚ã‚ãã†">ã‚„ã£ãŸã‚‰ãŠã‚‚ã‚ãã†</option>
        </select>

        <label>ãƒ•ã‚§ãƒ¼ã‚ºã®é”æˆæ¡ä»¶</label>
        <div>
            <span class="phase-icon" id="editPhase1" onclick="toggleEditPhase(1)">âŒ</span>
            <input type="text" id="editPhase1Name" placeholder="ãƒ•ã‚§ãƒ¼ã‚º1ã®åç§°ã‚’å…¥åŠ›">
        </div>
        <div>
            <span class="phase-icon" id="editPhase2" onclick="toggleEditPhase(2)">âŒ</span>
            <input type="text" id="editPhase2Name" placeholder="ãƒ•ã‚§ãƒ¼ã‚º2ã®åç§°ã‚’å…¥åŠ›">
        </div>
        <div>
            <span class="phase-icon" id="editPhase3" onclick="toggleEditPhase(3)">âŒ</span>
            <input type="text" id="editPhase3Name" placeholder="ãƒ•ã‚§ãƒ¼ã‚º3ã®åç§°ã‚’å…¥åŠ›">
        </div>
        <div>
          <label for="projectId">é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
          <select id="projectId">
              <option value="">ï¼ˆãªã—ï¼‰</option>
          </select>
      </div>
    </div>

    <div id="scheduleEditFields" style="display: none;">
        <label for="editScheduleDate">äºˆå®šæ—¥</label>
        <input type="date" id="editScheduleDate">

        <label for="editLocation">å ´æ‰€</label>
        <input type="text" id="editLocation">
    </div>

    <button onclick="saveTaskEdit()">ä¿å­˜</button>
    <button onclick="closeTaskEditPopup()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

  <script src="common.js"></script>
  <script>
    (function() {
      const mislengeList = getMislenge();
      const projects = getProjects();
      const tbody = document.getElementById("taskContainer");

      // ã‚¿ã‚¹ã‚¯ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®çµ±ä¸€ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã€æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedMislenge = {};

      mislengeList.forEach(item => {
          // Task ã¯ `scheduledDate`ã€Schedule ã¯ `scheduleDate` ã‚’åŸºæº–ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
          const dateKey = item.type === "Task" 
              ? (item.scheduledDate || "æœªè¨­å®š") 
              : (item.scheduleDate || "æœªè¨­å®š");

          if (!groupedMislenge[dateKey]) {
              groupedMislenge[dateKey] = [];
          }

          groupedMislenge[dateKey].push(item);
      });

      // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ã‚¯ãƒªã‚¢
      taskContainer.innerHTML = "";

      /*ãƒ•ã‚§ãƒ¼ã‚ºåˆ†ã‘
      const phaseConditions = {
      phase1: "ãƒ•ã‚§ãƒ¼ã‚º1é”æˆæ¡ä»¶: è¦ä»¶å®šç¾©å®Œäº†",
      phase2: "ãƒ•ã‚§ãƒ¼ã‚º2é”æˆæ¡ä»¶: è¨­è¨ˆå®Œäº†",
      phase3: "ãƒ•ã‚§ãƒ¼ã‚º3é”æˆæ¡ä»¶: å®Ÿè£…å®Œäº†"
    };*/

    const togglePhase = (taskId, phase) => {
      const tasks = getMislenge();
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        task[phase] = !task[phase];
        saveMislenge(tasks);

        // ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ã‚¤ã‚³ãƒ³ã®ã¿æ›´æ–°
        const phaseElement = document.querySelector(`[onclick="togglePhase('${taskId}', '${phase}')"]`);
        if (phaseElement) {
          phaseElement.textContent = task[phase] ? 'âœ…' : 'âŒ';
        }
      }
    };

    // æ—¥ä»˜ã”ã¨ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
    Object.keys(groupedMislenge).forEach(date => {
        const section = document.createElement("div");
        section.classList.add("task-group");

        section.innerHTML = `
            <h2 class="task-date">${date}</h2>
            <table class="task-table">
                <thead>
                    <tr>
                        <th>ç¨®é¡</th>
                        <th>åå‰</th>
                        <th>é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
                        <th>ç· ã‚åˆ‡ã‚Šæ—¥ / å ´æ‰€</th>
                        <th>äºˆå®šæ—¥</th>
                        <th>ãƒ•ã‚§ãƒ¼ã‚º</th>
                        <th>å„ªå…ˆåº¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${groupedMislenge[date].map(item => {
                        const project = projects.find(p => p.id === item.projectId);
                        const isTask = item.type === "Task";
                        const taskClass = isTask ? "task-row" : "schedule-row";

                        return `
                            <tr class="${taskClass}"  id="task-${item.id}" data-task-id="${item.id}">
                                <td>${isTask ? "ğŸ“ Task" : "ğŸ“… Schedule"}</td>
                                <td>${item.name}</td>
                                <td>${project ? project.name : "ï¼ˆãªã—ï¼‰"}</td>
                                <td>${isTask ? (item.deadline || "-") : (item.location || "æœªè¨­å®š")}</td>
                                <td>${isTask ? (item.scheduledDate || "æœªè¨­å®š") : (item.scheduleDate || "æœªè¨­å®š")}</td>
                                <td>
                                    ${isTask ? `
                                    <span class="phase-icon" title="${item.phase1Name || 'ãƒ•ã‚§ãƒ¼ã‚º1'}" onclick="togglePhase('${item.id}', 'phase1')">
                                        ${item.phase1 ? 'âœ…' : 'âŒ'}
                                    </span>
                                    <span class="phase-icon" title="${item.phase2Name || 'ãƒ•ã‚§ãƒ¼ã‚º2'}" onclick="togglePhase('${item.id}', 'phase2')">
                                        ${item.phase2 ? 'âœ…' : 'âŒ'}
                                    </span>
                                    <span class="phase-icon" title="${item.phase3Name || 'ãƒ•ã‚§ãƒ¼ã‚º3'}" onclick="togglePhase('${item.id}', 'phase3')">
                                        ${item.phase3 ? 'âœ…' : 'âŒ'}
                                    </span>
                                    ` : "-"}
                                </td>
                                <td>${isTask ? (item.priority || "æœªè¨­å®š") : "-"}</td>
                                <td>
                                    <button onclick="showTaskEditPopup('${item.id}')">ç·¨é›†</button>
                                    <button onclick="handleDelete('${item.id}')">å‰Šé™¤</button>
                                </td>
                            </tr>
                        `;
                    }).join("")}
                </tbody>
            </table>
        `;

        taskContainer.appendChild(section);
    });

    // å‰Šé™¤æ©Ÿèƒ½ï¼ˆãƒªã‚¹ãƒˆã‚’å³æ™‚æ›´æ–°ï¼‰
    window.handleDelete = function(mislengeId) {
        if (confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            deleteMislenge(mislengeId);
            alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            const row = document.querySelector(`[data-task-id="${mislengeId}"]`);
            if (row) {
                row.remove();
            }
        }
    };
})();

function showTaskEditPopup(taskId) {
        const task = getMislenge().find(m => m.id === taskId);
        const projects = getProjects();  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
        
        document.getElementById("editTaskName").value = task.name;

        if (task.type === "Task") {
            document.getElementById("taskEditFields").style.display = "block";
            document.getElementById("scheduleEditFields").style.display = "none";
            document.getElementById("editTaskDeadline").value = task.deadline || "";
            document.getElementById("editScheduledDate").value = task.scheduledDate || "";
            document.getElementById("editPriority").value = task.priority || "æœªè¨­å®š";
        } else {
            document.getElementById("taskEditFields").style.display = "none";
            document.getElementById("scheduleEditFields").style.display = "block";
            document.getElementById("editScheduleDate").value = task.scheduleDate || "";
            document.getElementById("editLocation").value = task.location || "";
        }

        // âœ… é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
        const projectSelect = document.getElementById("projectId");
        projectSelect.innerHTML = `<option value="">ï¼ˆãªã—ï¼‰</option>`;  // åˆæœŸåŒ–

        projects.forEach(project => {
            const option = document.createElement("option");
            option.value = project.id;
            option.textContent = project.name;
            if (project.id === task.projectId) {
                option.selected = true;  // é¸æŠä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åæ˜ 
            }
            projectSelect.appendChild(option);
        });

        document.getElementById("taskEditPopup").dataset.taskId = taskId;
        document.getElementById("taskEditPopup").classList.add("active");
    }

  function toggleEditPhase(phaseNumber) {
  const phaseElement = document.getElementById(`editPhase${phaseNumber}`);
  phaseElement.textContent = phaseElement.textContent === 'âœ…' ? 'âŒ' : 'âœ…';
}


function saveTaskEdit() {
  const taskId = document.getElementById("taskEditPopup").dataset.taskId;
  const name = document.getElementById("editTaskName").value;
  const deadline = document.getElementById("editTaskDeadline").value;
  const scheduledDate = document.getElementById("editScheduledDate").value;
  const priority = document.getElementById("editPriority").value;
  const projectId = document.getElementById("projectId").value;  // è¿½åŠ éƒ¨åˆ†

  // ãƒ•ã‚§ãƒ¼ã‚ºã®çŠ¶æ…‹ã‚’å–å¾—
  const phase1 = document.getElementById("editPhase1").textContent === 'âœ…';
  const phase2 = document.getElementById("editPhase2").textContent === 'âœ…';
  const phase3 = document.getElementById("editPhase3").textContent === 'âœ…';

  // ãƒ•ã‚§ãƒ¼ã‚ºã®åç§°ã‚’å–å¾—
  const phase1Name = document.getElementById("editPhase1Name").value || "ãƒ•ã‚§ãƒ¼ã‚º1";
  const phase2Name = document.getElementById("editPhase2Name").value || "ãƒ•ã‚§ãƒ¼ã‚º2";
  const phase3Name = document.getElementById("editPhase3Name").value || "ãƒ•ã‚§ãƒ¼ã‚º3";

  updateMislenge({ 
    id: taskId, name, deadline, scheduledDate, priority, 
    projectId,  // ã“ã“ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ä¿å­˜
    phase1, phase2, phase3, phase1Name, phase2Name, phase3Name 
  });

  alert("ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ");

  // ä¿®æ­£ã‚’å³æ™‚åæ˜ 
  const row = document.querySelector(`[data-task-id="${taskId}"]`);
  if (row) {
        const projects = getProjects();
        const project = projects.find(p => String(p.id) === String(projectId)); // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåå–å¾—

        row.cells[1].textContent = name; // åå‰
        row.cells[2].textContent = project ? project.name : "ï¼ˆãªã—ï¼‰"; // é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
        row.cells[3].textContent = deadline || "-"; // ç· ã‚åˆ‡ã‚Šæ—¥
        row.cells[4].textContent = scheduledDate || "æœªè¨­å®š"; // äºˆå®šæ—¥

        // ãƒ•ã‚§ãƒ¼ã‚ºã®æ›´æ–°
        row.cells[5].innerHTML = `
        <span class="phase-icon" title="${phase1Name}" onclick="togglePhase('${taskId}', 'phase1')">${phase1 ? 'âœ…' : 'âŒ'}</span>
        <span class="phase-icon" title="${phase2Name}" onclick="togglePhase('${taskId}', 'phase2')">${phase2 ? 'âœ…' : 'âŒ'}</span>
        <span class="phase-icon" title="${phase3Name}" onclick="togglePhase('${taskId}', 'phase3')">${phase3 ? 'âœ…' : 'âŒ'}</span>
    `;
        row.cells[6].textContent = priority || "æœªè¨­å®š";
  }

  closeTaskEditPopup();
}

function closeTaskEditPopup() {
    document.getElementById("taskEditPopup").classList.remove("active");
}

window.onload = function() {
    const hash = window.location.hash;
    if (hash) {
        const target = document.querySelector(hash);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
            target.style.backgroundColor = '#FFFFCC';  // âœ… å¼·èª¿è¡¨ç¤º
        }
    }
};


  </script>
</body>
</html>
